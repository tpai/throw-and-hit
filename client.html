<html>
	<head>
	<title>Throw & Hit / 你投我打</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<style type="text/css">
		.game_panel {
			display: none;
		}
		.container {
		  width: 320px;
		  max-width: 90%;
		}

		img {
		  max-width: 100%;
		  height: auto;
		}

		@media \0screen {
		  img {
		    width: auto; /* for ie 8 */
		  }
		}
	</style>
	<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="js/funcs.js"></script>
	<script>
	//custom settings
	var domain = "sampledomain.com";
	var port = "666";

	var socket = io.connect("http://"+domain+":"+port, {
		"force new connection": true
	});
	//player data
	var p1 = {
			username: "",
			career: "",
			round: 0,
			point: [],
			score: {
				strike: 0,
				hit: 0,
				homerun: 0
			}
		},
		p2 = {
			username: "",
			career: "",
			round: 0,
			point: [],
			score: {
				strike: 0,
				hit: 0,
				homerun: 0
			}
		};
	
	//when player connect to server, send player data to it.
	socket
	.on("connect", function () {
		console.log("connect!");
		$("#match").click(function() {
			if($("#username").prop("value") != "") {
				p1.username = $("#username").prop("value");
				p1.career = $("#career option:checked").prop("value");
				socket.emit("request", {order: "join", player: p1});
			}
			else {
				alert("You must type your name.\n你必須輸入一個名字.")
			}
		});
		//when click exitGame button, reset this game.
		$("input[name='exitGame']").click(resetGame);
	})
	.on("disconnect", function () {
		console.log("disconnect!");
	});
	//when player close window, reset this game.
	window.onbeforeunload = function() {
		resetGame();
		return undefined;
	};

	var resetGame = function() {
		$("#p1").html("none");
		$("#msg").html("");
		socket.emit("request", {order: "leave", player: p1}); //remove from idle_user arr
		socket.emit("exitGame", [p1, p2]); //notice opponent
		location.reload();
	};

	//notice that your opponent left this game
	socket.on("oppLeft", function(data) {
		if(data.player.username == p1.username &&
			data.player.career == p1.career &&
			data.player.username != "") {
			alert("Your opponent left!\n對手逃走了!");
			location.reload();
		}
	});
	
	//set your status to idle
	socket.on("idle", function() {
		$("#p1").html(p1.username);
		$("#msg").html("Waiting...\n<br>等待配對...");
	});
	
	//notice that your already found a opponent
	socket.on("notice", function(data) {
		for(var i=0;i<data.length;i++) {
			var val = data[i];
			if(p1.username == val.username && p1.career == val.career) {
				$("#p1").html(val.username);
				
				if(i == data.length - 1) {
					p2.username = data[i-1].username;
					p2.career = data[i-1].career;
				}
				else {
					p2.username = data[i+1].username;
					p2.career = data[i+1].career;
				}
				$("#p2").html(p2.username);
				
				$("#msg").html("Matched!\n<br>配對成功!");
				setTimeout(resetScene, 2500);
				break;
			}
		}
	});
	
	//receive duel message from server
	socket.on("match", function(data) {
		var user = data[1];
		if(user.username == p1.username && user.career == p1.career) {
			p2 = data[0];
			$("#enemypoint").prop("value", p2.point[p2.round-1]);
			console.log(p1.username+" match!")
			if(p1.career == "batter") {
				//-------
				$("#msg").html("Pitcher throw!\n<br>投手投出!");
				setPlayerIcon(2);
				//-------
				$("#stopRolling").prop("disabled", false);
				youcanroll();
			}
		}
	});
	
	//receive result message from server
	socket.on("result", function(data) {
		if(data.p1.username == p1.username || data.p2.username == p1.username) {
			if(p1.career == "pitcher") {
				setPlayerIcon(2);
				$("#enemypoint").prop("value", data.p1.point[data.p1.round-1]);
			}
			$("#msg").html(data.msg);
			switch(data.msgid) {
				case 1:
					p1.score.strike ++; break;
				case 2:
					p1.score.hit ++; break;
				case 3:
					p1.score.homerun ++; break;
			}
			console.log("p1: "+p1.point[p1.round-1]);
			console.log("p2: "+p2.point[p2.round-1]);
			setTimeout(resetScene, 2500);
		}
	});
	</script>
	</head>
	<body>
		<table width="320">
			<tr>
				<th colspan="2" align="center">
						<img src="images/logo.png" width="250">
						<div id="match_panel">
							<input type="text" id="username" placeholder="username">
							<p>
								<select id="career">
									<option value="pitcher">Pitcher / 投手
									<option value="batter">Batter / 打者
								</select>
							</p>
							<p>
								<input type="button" id="match" value="Match / 配對"> 
								<input type="button" name="exitGame" value="Reset / 重置">
							</p>
						</div>
						<div id="score" class="game_panel"></div>
				</th>
			</tr>
			<tr class="game_panel">
				<td align="right">
					<div id="p2">none</div><br>
					<progress id="enemypoint" max="100" value="0"></progress><br>
					<div id="p1">none</div><br>
					<progress id="minepoint" max="100" value="0"></progress><br>
					<p>
						<input type="button" id="stopRolling" value="">
						<input type="button" name="exitGame" value="Exit / 退出">
					</p>
				</td>
				<td align="center">
					<div id="player_icon" class="container"></div>
				</td>
			</tr>
			<tr>
				<th colspan="2">
					<div id="msg"></div>
				</th>
			</tr>
		</table>
	</body>
</html>	